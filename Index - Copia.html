<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
      :root { 
        --cor-primaria: #9966FF; 
        --cor-primaria-hover: #7F55D4; 
        --cor-fundo: #fbfaff; 
        --altura-header: 60px; 
        --altura-footer: 85px; /* Aumentado para acomodar o menu flutuante */
      }
      body { background-color: var(--cor-fundo); font-family: 'Segoe UI', sans-serif; padding-top: var(--altura-header); padding-bottom: var(--altura-footer); color: #4a4a4a; }
      .oculto { display: none !important; }
      
      /* Identidade Visual */
      .app-icon { height: 35px; width: 35px; object-fit: contain; }
      .login-logo { max-width: 220px; height: auto; margin-bottom: 25px; }
      
      /* Login */
      .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #9966FF 0%, #7F55D4 100%); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
      .login-box { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); width: 100%; max-width: 350px; border: 1px solid rgba(255,255,255,0.2); }

      /* Header */
      .app-header { position: fixed; top: 0; left: 0; width: 100%; height: var(--altura-header); background: white; display: flex; align-items: center; padding: 0 15px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

      /* Menu Inferior (Dock Style) */
      .bottom-nav { 
        position: fixed; 
        bottom: 20px; 
        left: 15px; 
        right: 15px; 
        height: 70px; 
        background: white; 
        border-radius: 20px; /* Arredondado */
        display: flex; 
        z-index: 1000; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Sombra mais bonita */
        padding: 0 10px; 
        align-items: center; 
        justify-content: space-around;
      }
      .nav-item { text-align: center; color: #b0b0b0; text-decoration: none; font-size: 0.7rem; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; transition: all 0.3s; cursor: pointer; border-radius: 15px; }
      .nav-item i { font-size: 1.5rem; margin-bottom: 3px; transition: all 0.3s; }
      .nav-item.active { color: var(--cor-primaria); font-weight: 600; }
      .nav-item.active i { transform: translateY(-3px); color: var(--cor-primaria); }

      /* Cards */
      .card-custom { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 16px; border: 1px solid #f0f0f0; }
      .card-custom:active { transform: scale(0.98); transition: transform 0.1s; }
      
      /* Botões e Inputs */
      .btn-primary { background-color: var(--cor-primaria); border-color: var(--cor-primaria); color: white; border-radius: 12px; padding: 10px 15px; }
      .form-control, .form-select { padding: 12px; border-radius: 12px; border: 1px solid #e0e0e0; background: #fafafa; }
      .form-control:focus { background: white; border-color: var(--cor-primaria); box-shadow: 0 0 0 3px rgba(153, 102, 255, 0.1); }
      
      /* Tags de Alunos (Para não resumir) */
      .badge-nome { font-size: 0.85rem; padding: 6px 10px; margin-bottom: 5px; display: inline-block; font-weight: normal !important; }
    </style>
  </head>
  <body>

    <div id="tela-login" class="login-wrapper">
      <div class="login-box text-center">
        <img src="https://app-desenvolvi.github.io/app/DesenvolVi_logo_branca.png" class="login-logo">
        <form onsubmit="fazerLogin(event)">
          <input type="text" class="form-control mb-3" name="usuario" placeholder="Usuário" required style="background: rgba(255,255,255,0.9);">
          <input type="password" class="form-control mb-4" name="senha" placeholder="Senha" required style="background: rgba(255,255,255,0.9);">
          <button type="submit" id="btn-login" class="btn btn-light w-100 p-3 fw-bold" style="color: var(--cor-primaria);">ENTRAR</button>
        </form>
      </div>
    </div>

    <div id="app-principal" class="oculto">
      <header class="app-header">
        <img src="https://app-desenvolvi.github.io/app/DesenvolVi_icon.png" class="app-icon">
        <h5 class="m-0 fw-bold text-primary ms-2" style="font-size: 1.3rem;">AppDesenvolVi</h5>
        <div id="info-usuario" class="ms-auto small text-muted text-end" style="line-height: 1.1;"></div>
      </header>

      <div class="container mt-3">
        
        <div id="tela-inicio">
          <div class="card-custom text-center py-4">
            <h4 class="text-primary fw-bold">Olá, Equipe!</h4>
            <p class="text-muted mb-0">Desenvolvimento com afeto</p>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <div class="card-custom text-center p-3 shadow-sm" onclick="navegar(event, 'tela-agenda', document.getElementById('nav-agenda')); carregarAulasHoje();" style="cursor:pointer; background: #FFF5F0; border: 1px solid #FFDAB9;">
                <i class="bi bi-calendar-check fs-1" style="color: #FF9966;"></i>
                <div class="mt-2 fw-bold text-dark">Agenda & Frequência</div>
              </div>
            </div>
            <div class="col-12 admin-only">
              <div class="card-custom text-center p-3 shadow-sm" onclick="navegar(event, 'tela-lista-contratos', document.getElementById('nav-contratos')); carregarContratos();" style="cursor:pointer; background: #f3f0ff;">
                <i class="bi bi-file-earmark-text fs-1 text-primary"></i>
                <div class="mt-2 fw-bold text-secondary">Gestão de Contratos</div>
              </div>
            </div>
            <div class="col-6">
              <div class="card-custom text-center p-3 shadow-sm" onclick="navegar(event, 'tela-lista-alunos'); carregarListaAlunos();" style="cursor:pointer;">
                <i class="bi bi-emoji-smile fs-1 text-primary"></i><div class="fw-bold mt-2 text-secondary">Alunos</div>
              </div>
            </div>
            <div class="col-6">
              <div class="card-custom text-center p-3 shadow-sm" onclick="navegar(event, 'tela-lista-turmas'); carregarListaTurmas();" style="cursor:pointer;">
                <i class="bi bi-calendar3 fs-1 text-success"></i><div class="fw-bold mt-2 text-secondary">Turmas</div>
              </div>
            </div>
          </div>
        </div>

        <div id="tela-agenda" class="oculto">
          <div class="d-flex justify-content-between mb-3 align-items-center">
            <h5 class="fw-bold m-0"><i class="bi bi-calendar-event text-warning"></i> Agenda</h5>
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="navegar(null, 'tela-inicio')">Voltar</button>
          </div>

          <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
            <li class="nav-item">
              <button class="nav-link active small" id="tab-dia" onclick="alternarVisaoAgenda('dia')">Visão Diária</button>
            </li>
            <li class="nav-item">
              <button class="nav-link small" id="tab-semana" onclick="alternarVisaoAgenda('semana')">Visão Semanal</button>
            </li>
          </ul>

          <div id="view-agenda-dia">
             <div class="d-flex align-items-center justify-content-between mb-3 bg-white p-2 rounded shadow-sm border">
               <button class="btn btn-outline-primary btn-sm rounded-circle shadow-sm" onclick="navegarAgenda(-1)"><i class="bi bi-chevron-left"></i></button>
               <input type="date" id="input-data-agenda" class="form-control border-0 text-center fw-bold text-primary" style="max-width: 150px;" onchange="carregarAulasData(this.value)">
               <button class="btn btn-outline-primary btn-sm rounded-circle shadow-sm" onclick="navegarAgenda(1)"><i class="bi bi-chevron-right"></i></button>
            </div>
            <div id="container-lista-agenda"></div>
          </div>

          <div id="view-agenda-semana" class="oculto">
            <div class="text-center small text-muted mb-2" id="label-semana-atual"></div>
            <div id="container-lista-semana"></div>
          </div>
        </div>

        <div id="tela-chamada-turma" class="oculto">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary m-0" id="titulo-chamada">Chamada</h5>
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="navegar(event, 'tela-agenda')">Voltar</button>
          </div>
          <div class="card-custom mb-3">
            <div class="section-title">Professora Responsável</div>
            <div id="display-professora-auto" class="fw-bold text-primary oculto"></div>
            <select class="form-select" id="sel-professora-frequencia"></select>
          </div>
          <div id="container-lista-chamada"></div>
        </div>

        <div id="tela-lista-contratos" class="oculto">
          <div class="d-flex justify-content-between mb-3 align-items-center">
            <h5 class="fw-bold text-primary m-0"><i class="bi bi-file-earmark-lock"></i> Contratos</h5>
            <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="navegar(event, 'tela-novo-contrato'); carregarDadosNovoContrato();">+ Novo</button>
          </div>
          <div id="container-lista-contratos"></div>
        </div>

        <div id="tela-novo-contrato" class="oculto">
          <div class="d-flex justify-content-between mb-3 align-items-center">
            <h5 class="fw-bold text-primary m-0">Gerar Novo Contrato</h5>
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="navegar(event, 'tela-lista-contratos')">Voltar</button>
          </div>
          <div class="card-custom">
            <form onsubmit="salvarContratoAdmin(event)">
              <div class="mb-3">
                <label class="small fw-bold">ALUNO</label>
                <select class="form-select" name="aluno" id="sel-contrato-aluno-admin" required></select>
              </div>
              <div class="mb-3">
                <label class="small fw-bold">UNIDADE</label>
                <select class="form-select" id="sel-contrato-unidade-admin" required></select>
              </div>
              <div class="mb-3">
                <label class="small fw-bold">PACOTE</label>
                <select class="form-select" name="pacote" id="sel-contrato-pacote-admin" onchange="atualizarPrecosAdmin()" required>
                  <option value="" disabled selected>Selecione a unidade...</option>
                </select>
              </div>

              <div id="box-preco-admin" class="p-3 mb-3 rounded" style="background: #f3f0ff; display:none; border: 1px dashed #9966FF;">
                <div class="d-flex justify-content-between small"><span>Preço Normal:</span> <span id="adm-txt-preco" class="fw-bold"></span></div>
                <div class="d-flex justify-content-between small text-danger"><span>Desconto:</span> <span id="adm-txt-desc" class="fw-bold"></span></div>
                <hr class="my-2">
                <div class="d-flex justify-content-between fw-bold text-primary h5"><span>VALOR FINAL:</span> <span id="adm-txt-valor"></span></div>
                <div class="text-end mt-1" style="font-size: 0.75rem; color: #666;">
                   <span class="fw-bold">Parcelado sem juros:</span> <span id="adm-txt-parcela"></span>
                </div>
                
                <input type="hidden" name="preco" id="adm-in-preco">
                <input type="hidden" name="desconto" id="adm-in-desc">
                <input type="hidden" name="valor" id="adm-in-valor">
                <input type="hidden" name="duracao" id="adm-in-duracao">
              </div>

              <div class="row g-2 mb-4">
                <div class="col-6"><label class="small fw-bold">INÍCIO</label><input type="date" class="form-control" name="inicio" id="adm-data-inicio" onchange="calcularTerminoAdmin()" required></div>
                <div class="col-6"><label class="small fw-bold">PREVISÃO</label><input type="date" class="form-control" name="previsao" id="adm-data-fim" readonly style="background: #eee;"></div>
              </div>
              <button type="submit" class="btn btn-primary w-100 p-3 fw-bold shadow">SALVAR CONTRATO</button>
            </form>
          </div>
        </div>

        <div id="tela-lista-alunos" class="oculto">
          <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold text-primary">Turminha</h5><button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="navegar(event, 'tela-inicio')">Voltar</button></div>
          <input type="search" id="busca-aluno" class="form-control mb-3" placeholder="Buscar aluno..." onkeyup="filtrarAlunos()">
          <div id="container-lista-alunos"></div>
        </div>
        
        <div id="tela-lista-turmas" class="oculto">
          <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold text-success">Turmas</h5><button class="btn btn-sm btn-success rounded-pill" onclick="navegar(event, 'tela-inicio')">Voltar</button></div>
          <div id="container-lista-turmas"></div>
        </div>

        <div id="tela-form-turma" class="oculto">
          <div class="d-flex justify-content-between mb-3 align-items-center">
            <h5 class="fw-bold text-primary m-0" id="titulo-form-turma">Nova Turma</h5>
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="navegar(null, 'tela-lista-turmas')">Cancelar</button>
          </div>
          <div class="card-custom">
            <form onsubmit="salvarTurma(event); return false;">
              <input type="hidden" id="turma-id">
              <input type="hidden" id="turma-status" value="NÃO">
              
              <div class="mb-3">
                <label class="small fw-bold">NOME DA TURMA (Automático)</label>
                <input type="text" class="form-control bg-light" id="turma-nome" placeholder="Gerado ao salvar (Unidade - Perfil)" readonly>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="small fw-bold">UNIDADE</label>
                  <select class="form-select" id="turma-unidade" required></select>
                </div>
                <div class="col-6">
                  <label class="small fw-bold">PERFIL</label>
                  <select class="form-select" id="turma-perfil" required></select>
                </div>
              </div>

              <div class="mb-3">
                <label class="small fw-bold">DIA DA SEMANA</label>
                <select class="form-select" id="turma-dia" required>
                  <option value="Segunda">Segunda-feira</option>
                  <option value="Terça">Terça-feira</option>
                  <option value="Quarta">Quarta-feira</option>
                  <option value="Quinta">Quinta-feira</option>
                  <option value="Sexta">Sexta-feira</option>
                  <option value="Sábado">Sábado</option>
                </select>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-6"><label class="small fw-bold">INÍCIO</label><input type="time" class="form-control" id="turma-inicio" required></div>
                <div class="col-6"><label class="small fw-bold">TÉRMINO</label><input type="time" class="form-control" id="turma-fim" required></div>
              </div>

              <div class="mb-4">
                <label class="small fw-bold">CAPACIDADE</label>
                <input type="number" class="form-control" id="turma-capacidade" required>
              </div>

              <hr>

              <div id="view-alunos-leitura" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                   <label class="small fw-bold text-primary">ALUNOS MATRICULADOS</label>
                   <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="ativarEdicaoMatriculas()">
                     <i class="bi bi-pencil"></i> Editar Lista
                   </button>
                </div>
                <div id="lista-nomes-apenas" class="p-3 bg-light rounded border small text-muted">Carregando...</div>
              </div>

              <div id="view-alunos-edicao" class="mb-3 oculto">
                <label class="small fw-bold text-danger">EDITAR MATRÍCULAS</label>
                <input type="text" class="form-control mb-2 form-control-sm" id="busca-aluno-turma" placeholder="Filtrar aluno..." onkeyup="filtrarChecklistAlunos()">
                <div id="checklist-alunos" class="border rounded p-2 mb-2" style="max-height: 200px; overflow-y: auto; background: #fff;">Carregando...</div>
                <div class="text-end"><button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelarEdicaoMatriculas()">Ocultar Lista</button></div>
              </div>

              <button type="submit" class="btn btn-primary w-100 p-3 fw-bold mt-3">SALVAR TURMA</button>
            </form>
          </div>
        </div>

      </div>

      <nav class="bottom-nav">
        <a class="nav-item active" id="nav-inicio" onclick="navegar(event, 'tela-inicio', this)"><i class="bi bi-house-heart-fill"></i>Início</a>
        <a class="nav-item" id="nav-agenda" onclick="navegar(event, 'tela-agenda', this); carregarAulasHoje();"><i class="bi bi-calendar-check"></i>Agenda</a>
        <a class="nav-item admin-only" id="nav-contratos" onclick="navegar(event, 'tela-lista-contratos', this); carregarContratos();"><i class="bi bi-file-earmark-text"></i>Contratos</a>
        <a class="nav-item text-danger" onclick="location.reload()"><i class="bi bi-box-arrow-right"></i>Sair</a>
      </nav>
    </div>

    <script>
      let userLogado = { nome: "", unidade: "", perfil: "" };
      let listaAlunosCache = [];
      let pacotesAdmin = [];
      let pacoteAtivoAdmin = null;
      let dataAulaSelecionada = "";
      let listaChamadaAtual = [];
      let idAulaAtual = null;

      function fazerLogin(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-login'); btn.disabled = true;
        google.script.run.withSuccessHandler(res => {
          if(res.erro) { alert(res.msg); btn.disabled = false; }
          else {
            userLogado = res;
            document.getElementById('tela-login').classList.add('oculto');
            document.getElementById('app-principal').classList.remove('oculto');
            
            // Info de Unidade
            let infoUnidade = res.unidade ? res.unidade : "Todas as Unidades";
            document.getElementById('info-usuario').innerHTML = `<b>${res.nome}</b><br><small>${infoUnidade}</small>`;
            
            aplicarPermissoes(); // APLICA AS REGRAS
            carregarOpcoes();
          }
        }).verificarLogin({usuario: e.target.usuario.value, senha: e.target.senha.value});
      }

      function aplicarPermissoes() {
        const perfil = userLogado.perfil;
        
        // Se não for ADMIN, esconde tudo que for 'admin-only'
        if (perfil !== "ADMINISTRADOR") {
          document.querySelectorAll('.admin-only').forEach(el => el.classList.add('oculto'));
        } else {
          document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('oculto'));
        }
      }

      function carregarOpcoes() {
        // Envia Unidade para filtro
        google.script.run.withSuccessHandler(op => {
          const fill = (id, list, txt) => {
            const el = document.getElementById(id); if(!el) return;
            el.innerHTML = `<option value="" selected disabled>${txt}</option>`;
            if(list) list.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
          };
          fill('sel-professora-frequencia', op.professoras, 'Selecione a Professora...');
          
          google.script.run.withSuccessHandler(alunos => {
            const sel = document.getElementById('sel-contrato-aluno-admin');
            sel.innerHTML = '<option value="" disabled selected>Escolha o aluno...</option>';
            alunos.forEach(a => sel.innerHTML += `<option value="${a.identificacao}">${a.identificacao}</option>`);
          }).listarAlunos(userLogado.unidade); // Envia Unidade
        }).buscarOpcoesAuxiliares(userLogado.unidade); // Envia Unidade
      }

      function navegar(e, id, elMenu) {
        if(e) e.preventDefault();
        const telas = ['tela-inicio','tela-lista-alunos','tela-lista-turmas','tela-agenda','tela-chamada-turma','tela-lista-contratos','tela-novo-contrato', 'tela-form-turma'];
        telas.forEach(t => { if(document.getElementById(t)) document.getElementById(t).classList.add('oculto'); });
        document.getElementById(id).classList.remove('oculto');
        if(elMenu) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); elMenu.classList.add('active'); }
        window.scrollTo(0,0);
      }

      // --- AGENDA E CHAMADA ---
      function carregarAulasHoje() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('input-data-agenda').value = hoje;
        carregarAulasData(hoje);
      }

      function carregarAulasData(data) {
        dataAulaSelecionada = data;
        const cont = document.getElementById('container-lista-agenda');
        cont.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>';
        google.script.run.withSuccessHandler(aulas => {
          cont.innerHTML = "";
          if(!aulas || aulas.length === 0) { cont.innerHTML = '<div class="card-custom text-center p-4">Nenhuma aula.</div>'; return; }
          aulas.forEach(a => {
            cont.innerHTML += montarCardPadrao(a, 'chamada', data);
          });
        }).buscarAulasPorData(data, userLogado.unidade); // Envia Unidade
      }

      function abrirChamada(nomeTurma) {
        document.getElementById('titulo-chamada').innerText = nomeTurma;
        const cont = document.getElementById('container-lista-chamada');
        cont.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
        const dispAuto = document.getElementById('display-professora-auto');
        const selProf = document.getElementById('sel-professora-frequencia');
        if(userLogado.perfil === "PROFESSOR") { dispAuto.innerText = userLogado.nome; dispAuto.classList.remove('oculto'); selProf.classList.add('oculto'); }
        else { dispAuto.classList.add('oculto'); selProf.classList.remove('oculto'); selProf.value = ""; }
        navegar(null, 'tela-chamada-turma');
        google.script.run.withSuccessHandler(existente => {
          idAulaAtual = existente ? existente.idAula : null;
          google.script.run.withSuccessHandler(alunos => {
            cont.innerHTML = "";
            listaChamadaAtual = alunos.map(a => ({ ...a, status: (existente && existente.frequencia[a.identificacao]) ? existente.frequencia[a.identificacao] : 'PRESENTE' }));
            listaChamadaAtual.forEach((a, idx) => {
              const border = a.status === 'PRESENTE' ? 'border-success' : 'border-danger';
              cont.innerHTML += `
                <div class="card-custom mb-2 p-3 d-flex justify-content-between align-items-center border-start border-4 ${border}" id="card-alu-${idx}">
                  <div class="fw-bold" style="max-width: 50%">${a.nome}</div>
                  <div class="btn-group shadow-sm">
                    <button class="btn btn-sm ${a.status === 'PRESENTE' ? 'btn-success' : 'btn-outline-secondary'}" id="btn-p-${idx}" onclick="setPresenca(${idx}, 'PRESENTE')">P</button>
                    <button class="btn btn-sm ${a.status === 'AUSENTE' ? 'btn-danger' : 'btn-outline-secondary'}" id="btn-a-${idx}" onclick="setPresenca(${idx}, 'AUSENTE')">F</button>
                  </div>
                </div>`;
            });
            cont.innerHTML += `
              <div class="card-custom mt-4"><div class="section-title"><i class="bi bi-pencil-square"></i> Diário de Aula</div>
              <textarea id="obs-aula" class="form-control" rows="4">${existente ? existente.observacoes : ""}</textarea></div>
              <button class="btn btn-primary w-100 p-3 mt-3 mb-5 fw-bold shadow-lg" onclick="enviarFrequencia('${nomeTurma}')">SALVAR AULA</button>`;
          }).buscarAlunosDaTurma(nomeTurma);
        }).buscarDadosAulaExistente(nomeTurma, dataAulaSelecionada);
      }

      function setPresenca(idx, st) {
        listaChamadaAtual[idx].status = st;
        const card = document.getElementById(`card-alu-${idx}`);
        const btnP = document.getElementById(`btn-p-${idx}`);
        const btnA = document.getElementById(`btn-a-${idx}`);
        if(st === 'PRESENTE') { card.className = 'card-custom mb-2 p-3 d-flex justify-content-between align-items-center border-start border-4 border-success'; btnP.className = 'btn btn-sm btn-success'; btnA.className = 'btn btn-sm btn-outline-secondary'; }
        else { card.className = 'card-custom mb-2 p-3 d-flex justify-content-between align-items-center border-start border-4 border-danger'; btnP.className = 'btn btn-sm btn-outline-secondary'; btnA.className = 'btn btn-sm btn-danger'; }
      }

      function enviarFrequencia(turma) {
        let prof = userLogado.perfil === "PROFESSOR" ? userLogado.nome : document.getElementById('sel-professora-frequencia').value;
        if(!prof) { alert("Selecione a professora!"); return; }
        const btn = event.target; btn.disabled = true; btn.innerText = "Salvando...";
        google.script.run.withSuccessHandler(res => { 
          alert(res); 
          navegar(null, 'tela-agenda'); 
          carregarAulasData(dataAulaSelecionada); 
        }).finalizarAulaRede({ 
          idAula: idAulaAtual, 
          turma: turma, 
          professora: prof, 
          alunos: listaChamadaAtual, 
          data: dataAulaSelecionada, 
          observacoes: document.getElementById('obs-aula').value 
        });
      }

      function navegarAgenda(direcao) {
        const viewDia = document.getElementById('view-agenda-dia');
        const isModoDia = viewDia && !viewDia.classList.contains('oculto');
        
        if(isModoDia) {
           const input = document.getElementById('input-data-agenda'); 
           if(!input || !input.value) return;
           
           // Avança ou volta um dia
           let d = new Date(input.value + "T12:00:00"); 
           d.setDate(d.getDate() + direcao);
           const novaData = d.toISOString().split('T')[0]; 
           
           input.value = novaData; 
           carregarAulasData(novaData);
        } else {
           // Modo Semana (mantém a lógica existente)
           dataReferenciaSemana.setDate(dataReferenciaSemana.getDate() + (direcao * 7)); 
           renderizarSemana();
        }
      }

      // --- CONTRATOS ---
      function carregarContratos() {
        const cont = document.getElementById('container-lista-contratos');
        cont.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
        google.script.run.withSuccessHandler(lista => {
          cont.innerHTML = "";
          if(lista.length === 0) { cont.innerHTML = "Nenhum contrato ativo."; return; }
          lista.forEach(c => {
            let fone = c.celular ? c.celular.replace(/\D/g, '') : "";
            if(fone && fone.length <= 11) fone = "55" + fone;
            cont.innerHTML += `
              <div class="card-custom card-contrato shadow-sm p-3">
                <div class="d-flex justify-content-between">
                  <div class="fw-bold text-dark"><i class="bi bi-person"></i> ${c.aluno}</div>
                  <span class="badge ${c.status === 'ATIVO' ? 'bg-success' : 'bg-danger'}">${c.status}</span>
                </div>
                <div class="mt-2 small">
                  <div><i class="bi bi-box"></i> <b>Pacote:</b> ${c.pacote}</div>
                  <div class="text-primary h5 fw-bold mt-1">R$ ${c.valor}</div>
                  <div class="text-muted"><i class="bi bi-calendar"></i> <b>Vigente até:</b> ${c.previsao}</div>
                </div>
                ${fone ? `<a href="https://wa.me/${fone}" target="_blank" class="btn btn-sm btn-success w-100 mt-3"><i class="bi bi-whatsapp"></i> Falar no WhatsApp</a>` : ''}
              </div>`;
          });
        }).listarContratos(userLogado.unidade); // Envia Unidade
      }

      function carregarDadosNovoContrato() {
        google.script.run.withSuccessHandler(res => {
          pacotesAdmin = res.pacotes;
          const selU = document.getElementById('sel-contrato-unidade-admin');
          selU.innerHTML = '<option value="" disabled selected>Unidade...</option>';
          res.unidades.forEach(u => selU.innerHTML += `<option value="${u}">${u}</option>`);
          selU.onchange = () => {
            const selP = document.getElementById('sel-contrato-pacote-admin');
            selP.innerHTML = '<option value="" disabled selected>Pacote...</option>';
            pacotesAdmin.filter(p => p.unidade === selU.value).forEach(p => {
              selP.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
            });
          };
        }).buscarDadosIniciaisCadastro();
      }

      function atualizarPrecosAdmin() {
        const nome = document.getElementById('sel-contrato-pacote-admin').value;
        pacoteAtivoAdmin = pacotesAdmin.find(p => p.nome === nome);
        if(pacoteAtivoAdmin) {
          document.getElementById('box-preco-admin').style.display = 'block';
          document.getElementById('adm-txt-preco').innerText = "R$ " + pacoteAtivoAdmin.preco;
          document.getElementById('adm-txt-desc').innerText = pacoteAtivoAdmin.desconto;
          document.getElementById('adm-txt-valor').innerText = "R$ " + pacoteAtivoAdmin.valor;
          document.getElementById('adm-txt-parcela').innerText = pacoteAtivoAdmin.descricaoPreco;
          document.getElementById('adm-in-preco').value = pacoteAtivoAdmin.preco;
          document.getElementById('adm-in-desc').value = pacoteAtivoAdmin.desconto;
          document.getElementById('adm-in-valor').value = pacoteAtivoAdmin.valor;
          document.getElementById('adm-in-duracao').value = pacoteAtivoAdmin.duracao;
          calcularTerminoAdmin();
        }
      }

      function calcularTerminoAdmin() {
        const inicio = document.getElementById('adm-data-inicio').value;
        if(inicio && pacoteAtivoAdmin) {
          let d = new Date(inicio + "T12:00:00");
          d.setMonth(d.getMonth() + parseInt(pacoteAtivoAdmin.duracao));
          document.getElementById('adm-data-fim').value = d.toISOString().split('T')[0];
        }
      }

      function salvarContratoAdmin(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button'); btn.disabled = true;
        google.script.run.withSuccessHandler(res => { alert(res); navegar(null, 'tela-lista-contratos'); carregarContratos(); }).salvarContratoAdmin({ aluno: e.target.aluno.value, pacote: e.target.pacote.value, preco: document.getElementById('adm-in-preco').value, desconto: document.getElementById('adm-in-desc').value, valor: document.getElementById('adm-in-valor').value, inicio: e.target.inicio.value, previsao: e.target.previsao.value });
      }

      // --- OUTROS ---
      function carregarListaAlunos() { 
        google.script.run.withSuccessHandler(lista => { 
            listaAlunosCache = lista; 
            renderAlunos(lista); 
        }).listarAlunos(userLogado.unidade); // Envia Unidade
      }
      function renderAlunos(lista) { const cont = document.getElementById('container-lista-alunos'); cont.innerHTML = ""; lista.forEach(a => { cont.innerHTML += `<div class="card-custom"><b>${a.nome}</b><br><small class="text-muted">${a.unidade}</small></div>`; }); }
      function filtrarAlunos() { const t = document.getElementById('busca-aluno').value.toLowerCase(); renderAlunos(listaAlunosCache.filter(a => a.nome.toLowerCase().includes(t))); }

      // --- FÁBRICA DE CARTÕES ---
      function montarCardPadrao(t, tipoAcao, dataAgenda = null) {
        let statusBadge = t.inativo === "SIM" ? '<span class="badge bg-secondary">INATIVA</span>' : '<span class="badge bg-success">ATIVA</span>';
        
        let htmlAlunos = "";
        if(Array.isArray(t.listaAlunos) && t.listaAlunos.length > 0) {
          // Alterado para flex-wrap para mostrar todos os detalhes no celular
          htmlAlunos = `<div class="mt-3 pt-2 border-top d-flex flex-wrap gap-1">`;
          t.listaAlunos.forEach(aluno => { 
            if(aluno && aluno.trim() !== "") {
               htmlAlunos += `<span class="badge bg-light text-dark border badge-nome">${aluno}</span>`; 
            }
          });
          htmlAlunos += `</div>`;
        } else { 
          htmlAlunos = `<div class="mt-2 pt-2 border-top small text-muted fst-italic">Sem alunos matriculados</div>`; 
        }

        let botaoHtml = "";
        if (tipoAcao === 'editar') {
           // Admin edita, outros só veem (se necessário lógica futura)
           let dadosJson = JSON.stringify(t).replace(/"/g, '&quot;');
           botaoHtml = `<button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="abrirFormTurma(${dadosJson})"><i class="bi bi-pencil"></i> Detalhes</button>`;
        } else if (tipoAcao === 'chamada') {
           botaoHtml = `<button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="navegar(null, 'tela-chamada-turma'); abrirChamadaComData('${t.nome}', '${dataAgenda}', '${t.inicio}')"><i class="bi bi-check2-square"></i> Chamada</button>`;
        }

        return `
          <div class="card-custom card-turma shadow-sm p-3 mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="fw-bold text-dark fs-5">${t.nome}</div>
                <div class="small text-muted">${t.unidade} &bull; ${t.perfil}</div>
              </div>
              ${statusBadge}
            </div>
            <div class="d-flex gap-3 my-2 small text-secondary">
              <div><i class="bi bi-calendar3"></i> ${t.dia}</div>
              <div><i class="bi bi-clock"></i> ${t.inicio} - ${t.fim}</div>
            </div>
            ${htmlAlunos}
            ${botaoHtml}
          </div>`;
      }

      // --- TURMAS ---
      function carregarListaTurmas() {
        const cont = document.getElementById('container-lista-turmas');
        const header = document.querySelector('#tela-lista-turmas .d-flex');
        header.innerHTML = `<h5 class="fw-bold text-success m-0">Turmas</h5><button class="btn btn-sm btn-success rounded-pill px-3" onclick="abrirFormTurma()">+ Nova Turma</button>`;
        cont.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-success"></div></div>';
        
        google.script.run.withSuccessHandler(lista => {
          cont.innerHTML = "";
          if(lista.length === 0) { cont.innerHTML = "Nenhuma turma cadastrada."; return; }
          lista.forEach(t => {
            cont.innerHTML += montarCardPadrao(t, 'editar');
          });
        }).listarTurmas(userLogado.unidade); // Envia Unidade
      }

      // --- GESTÃO DE TURMA ---
      let cacheTodosAlunos = [];
      let alunosAtuaisDaTurma = [];

      function abrirFormTurma(dados = null) {
        google.script.run.withSuccessHandler(res => {
          cacheTodosAlunos = res.todosAlunos.sort();
          
          const selU = document.getElementById('turma-unidade');
          const selP = document.getElementById('turma-perfil');
          selU.innerHTML = '<option value="" disabled selected>Unidade...</option>';
          res.unidades.forEach(u => selU.innerHTML += `<option value="${u}">${u}</option>`);
          selP.innerHTML = '<option value="" disabled selected>Perfil...</option>';
          res.perfis.forEach(p => selP.innerHTML += `<option value="${p}">${p}</option>`);

          document.getElementById('view-alunos-leitura').classList.remove('oculto');
          document.getElementById('view-alunos-edicao').classList.add('oculto');

          if(dados) {
            document.getElementById('titulo-form-turma').innerText = "Editar Turma";
            document.getElementById('turma-id').value = dados.id;
            document.getElementById('turma-nome').value = dados.nome;
            document.getElementById('turma-unidade').value = dados.unidade;
            document.getElementById('turma-perfil').value = dados.perfil;
            document.getElementById('turma-dia').value = dados.dia;
            document.getElementById('turma-inicio').value = dados.inicio;
            document.getElementById('turma-fim').value = dados.fim;
            document.getElementById('turma-capacidade').value = dados.capacidade;
            document.getElementById('turma-status').value = dados.inativo;

            const listaLeitura = document.getElementById('lista-nomes-apenas');
            listaLeitura.innerHTML = "Buscando alunos...";
            google.script.run.withSuccessHandler(alunos => {
               alunosAtuaisDaTurma = alunos.map(a => a.identificacao);
               if(alunos.length === 0) {
                 listaLeitura.innerHTML = "Nenhum aluno matriculado.";
               } else {
                 listaLeitura.innerHTML = "";
                 alunos.forEach(a => {
                   listaLeitura.innerHTML += `<div class="border-bottom py-1"><i class="bi bi-person-check text-success"></i> ${a.identificacao}</div>`;
                 });
               }
               renderizarChecklist(alunosAtuaisDaTurma);
            }).buscarAlunosDaTurma(dados.nome);

          } else {
            document.getElementById('titulo-form-turma').innerText = "Nova Turma";
            document.getElementById('turma-id').value = "";
            document.getElementById('turma-nome').value = "";
            document.getElementById('turma-unidade').value = "";
            document.getElementById('turma-perfil').value = "";
            document.getElementById('turma-dia').value = "Segunda";
            document.getElementById('turma-inicio').value = "";
            document.getElementById('turma-fim').value = "";
            document.getElementById('turma-capacidade').value = "";
            document.getElementById('turma-status').value = "NÃO";
            
            document.getElementById('lista-nomes-apenas').innerHTML = "Salve a turma para matricular alunos.";
            alunosAtuaisDaTurma = [];
            renderizarChecklist([]);
          }
          navegar(null, 'tela-form-turma');
        }).buscarOpcoesAuxiliares(userLogado.unidade); // Envia Unidade
      }

      function ativarEdicaoMatriculas() {
        document.getElementById('view-alunos-leitura').classList.add('oculto');
        document.getElementById('view-alunos-edicao').classList.remove('oculto');
        renderizarChecklist(alunosAtuaisDaTurma); 
      }

      function cancelarEdicaoMatriculas() {
        document.getElementById('view-alunos-edicao').classList.add('oculto');
        document.getElementById('view-alunos-leitura').classList.remove('oculto');
      }

      function renderizarChecklist(selecionados) {
        const div = document.getElementById('checklist-alunos');
        div.innerHTML = "";
        if(cacheTodosAlunos.length === 0) { div.innerHTML = "Nenhum aluno ativo encontrado."; return; }
        
        cacheTodosAlunos.forEach(aluno => {
          const isChecked = selecionados.includes(aluno) ? "checked" : "";
          div.innerHTML += `
            <div class="form-check item-aluno border-bottom py-1">
              <input class="form-check-input" type="checkbox" value="${aluno}" id="chk-${aluno}" ${isChecked}>
              <label class="form-check-label small" for="chk-${aluno}">${aluno}</label>
            </div>`;
        });
      }

      function filtrarChecklistAlunos() {
        const termo = document.getElementById('busca-aluno-turma').value.toLowerCase();
        const itens = document.querySelectorAll('.item-aluno');
        itens.forEach(item => {
          const texto = item.innerText.toLowerCase();
          item.style.display = texto.includes(termo) ? "block" : "none";
        });
      }

      function salvarTurma(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button'); 
        btn.disabled = true; btn.innerText = "SALVANDO...";

        const checkboxes = document.querySelectorAll('#checklist-alunos input[type="checkbox"]:checked');
        const alunosSelecionados = Array.from(checkboxes).map(cb => cb.value);

        const d = {
          id: document.getElementById('turma-id').value,
          nome: document.getElementById('turma-nome').value,
          unidade: document.getElementById('turma-unidade').value,
          perfil: document.getElementById('turma-perfil').value,
          dia: document.getElementById('turma-dia').value,
          inicio: document.getElementById('turma-inicio').value,
          fim: document.getElementById('turma-fim').value,
          capacidade: document.getElementById('turma-capacidade').value,
          inativo: document.getElementById('turma-status').value,
          alunosSelecionados: alunosSelecionados
        };

        google.script.run.withSuccessHandler(res => {
          alert(res);
          btn.disabled = false; btn.innerText = "SALVAR TURMA";
          navegar(null, 'tela-lista-turmas');
          carregarListaTurmas();
        }).salvarTurma(d);
      }

      // --- AGENDA SEMANAL ---
      function alternarVisaoAgenda(modo) {
        if(modo === 'dia') {
          document.getElementById('tab-dia').classList.add('active');
          document.getElementById('tab-semana').classList.remove('active');
          document.getElementById('view-agenda-dia').classList.remove('oculto');
          document.getElementById('view-agenda-semana').classList.add('oculto');
        } else {
          document.getElementById('tab-dia').classList.remove('active');
          document.getElementById('tab-semana').classList.add('active');
          document.getElementById('view-agenda-dia').classList.add('oculto');
          document.getElementById('view-agenda-semana').classList.remove('oculto');
          carregarAgendaSemanal();
        }
      }

      function carregarAgendaSemanal() {
        const cont = document.getElementById('container-lista-semana');
        cont.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>';
        google.script.run.withSuccessHandler(turmas => {
          cacheTurmasSemanais = turmas.filter(t => t.inativo !== "SIM");
          renderizarSemana();
        }).listarTurmas(userLogado.unidade); // Envia Unidade
      }

      function renderizarSemana() {
        const cont = document.getElementById('container-lista-semana');
        cont.innerHTML = "";
        
        const diasOrdenados = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        const hoje = new Date();
        const diaSemanaHoje = hoje.getDay(); 
        const diffSegunda = hoje.getDate() - diaSemanaHoje + (diaSemanaHoje == 0 ? -6 : 1); 
        let segundaFeira = new Date(hoje.setDate(diffSegunda));

        const datasSemana = {};
        diasOrdenados.forEach((diaNome, index) => {
           let dataDia = new Date(segundaFeira);
           dataDia.setDate(segundaFeira.getDate() + index);
           datasSemana[diaNome] = dataDia.toISOString().split('T')[0];
        });

        document.getElementById('label-semana-atual').innerText = `Semana de ${datasSemana['Segunda'].split('-').reverse().slice(0,2).join('/')} a ${datasSemana['Sábado'].split('-').reverse().slice(0,2).join('/')}`;

        diasOrdenados.forEach(dia => {
          const turmasDia = cacheTurmasSemanais.filter(t => t.dia === dia).sort((a,b) => a.inicio.localeCompare(b.inicio));
          if(turmasDia.length > 0) {
            let htmlTurmas = "";
            turmasDia.forEach(t => {
              htmlTurmas += montarCardPadrao(t, 'chamada', datasSemana[dia]);
            });
            cont.innerHTML += `
              <div class="mb-4">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-3 sticky-top bg-light" style="top: 60px; z-index: 10;">
                  ${dia} <small class="text-muted fw-normal ms-2">${datasSemana[dia].split('-').reverse().slice(0,2).join('/')}</small>
                </h6>
                ${htmlTurmas}
              </div>`;
          }
        });
        if(cont.innerHTML === "") cont.innerHTML = '<div class="text-center p-4 text-muted">Sem aulas nesta semana.</div>';
      }

      function abrirChamadaComData(nomeTurma, data) {
        dataAulaSelecionada = data; 
        document.getElementById('input-data-agenda').value = data; 
        abrirChamada(nomeTurma);
      }
    </script>
  </body>
</html>